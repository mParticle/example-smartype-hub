name: 'Generate Data Plans'

on:
  workflow_dispatch:

jobs:
  # Downloads latest Smartype Jar and archives so it can be shared by each build process
  download-smartype-jar:
    name: Download Latest Smartype Jar
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Get Smartype Jar
        run: |
          curl https://repo1.maven.org/maven2/com/mparticle/smartype-generator/1.2.1/smartype-generator-1.2.1.jar > smartype.jar
      - name: Archive Smartype Jar
        uses: actions/upload-artifact@v2
        with:
          name: smartype-jar
          path: smartype.jar

  # Reads config.json and generates simultaneous builds for each data plan file
  generate-matrix:
    name: Generate Matrix for Data Plan Fetch
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Use Node.js
        uses: actions/setup-node@v1
        with:
          node-version: '12.x'

      - name: Set Matrix
        id: set-matrix
        run: echo "::set-output name=matrix::$(node scripts/generate-matrix.js mp.config.json)"

  # Generates a Data Plan Smartype Distirbution and publishes to NPM
  generate-data-plan:
    name: Generate package for Data Plan "${{ matrix.dataPlanId }} v${{ matrix.version }}
    runs-on: ubuntu-latest
    needs:
      - generate-matrix
      - download-smartype-jar
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Use Node.js
        uses: actions/setup-node@v1
        with:
          node-version: '12.x'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@${{github.actor}}'

      # Reads output folder from config file. This folder must exist
      # in file system before executing action
      - name: Get Output Folder
        id: setOutputFolder
        uses: notiz-dev/github-action-json-property@release
        with:
          path: mp.config.json
          prop_path: 'smartypeHubConfig.outputFolder'

      - name: Generate Output Folder Path
        id: getDataPlanVersionPath
        run: echo "::set-output name=dataPlanPath::${{ steps.setOutputFolder.outputs.prop }}/${{ matrix.dataPlanId }}_${{ matrix.version }}.json"

      # This is a safety check to make sure we can write to the file
      # before attempting to fetch data plan from mParticle
      - name: Touch Data Plan File
        run: touch ${{ steps.getDataPlanVersionPath.outputs.dataPlanPath }}

      - name: Install mP CLI
        run: npm install -g @mparticle/cli

      # Make sure secrets are set up before running this action:
      # https://docs.github.com/en/free-pro-team@latest/actions/reference/encrypted-secrets
      - name: Fetch Data Plan with mp CLI
        env:
          WORKSPACE_ID: ${{ secrets.MP_WORKSPACE_ID }}
          CLIENT_ID: ${{ secrets.MP_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.MP_CLIENT_SECRET }}
        run: |
          mp planning:data-plan-versions:fetch --dataPlanId=${{ matrix.dataPlanId}} --versionNumber=${{ matrix.version }} --outFile=${{ steps.getDataPlanVersionPath.outputs.dataPlanPath }} --workspaceId=$WORKSPACE_ID --clientId=$CLIENT_ID --clientSecret=$CLIENT_SECRET

      # This specific Github Action won't fail if lastModifiedOn is missing
      # from the JSON file. Rather it will set it as an empty value
      # so we can test later
      #
      # As a convention, we are setting first time data plan versions to X.0.0
      # as the package version number. Data Plan Versions that have been modified
      # will have a last modified on date, which will result in a package version
      # of X.YYYYMMDD.HHMMSS
      - name: Get Last Modified On
        id: lastModifiedOn
        uses: ashley-taylor/read-json-property-action@v1.0
        with:
          path: ${{ steps.getDataPlanVersionPath.outputs.dataPlanPath }}
          property: 'last_modified_on'
      - name: Check last modified
        id: getPackageVersion
        run: |
          LAST_MODIFIED_ON="${{ steps.lastModifiedOn.outputs.value }}"
          echo "Last Mod: $LAST_MODIFIED_ON"
          if [ -z $LAST_MODIFIED_ON ];
          then
            echo "Last Modified is empty, setting version to X.0.0"
            echo ::set-output name=packageVersion::${{matrix.version}}.0.0
          else
            echo "Last Modified has a value, setting version to last modified date"
            echo ::set-output name=packageVersion::${{matrix.version}}.$(date -d "$LAST_MODIFIED_ON" '+%Y%m%d.%H%M%S')
          fi

      - name: Echo Package Version
        run: echo ${{ steps.getPackageVersion.outputs.packageVersion }}

      - name: Modify Package Name
        uses: MerthinTechnologies/edit-json-action@v1
        with:
          filename: 'template/package.json'
          key: 'name'
          value: '@${{github.repository}}-${{matrix.dataPlanId}}'

      - name: Modify Repository
        uses: MerthinTechnologies/edit-json-action@v1
        with:
          filename: 'template/package.json'
          key: 'repository'
          value: 'git@github.com:${{github.repository}}.git'

      - name: Modify Package Version
        uses: MerthinTechnologies/edit-json-action@v1
        with:
          filename: 'template/package.json'
          key: 'version'
          value: ${{ steps.getPackageVersion.outputs.packageVersion }}

      - name: Cat Package.json
        run: cat template/package.json

      - name: Copy smartype.config.json template
        run: cp template/smartype.config.json .

      - name: Modify Smartype Config apiSchemaFile
        uses: MerthinTechnologies/edit-json-action@v1
        with:
          filename: 'smartype.config.json'
          key: apiSchemaFile
          value: ${{ steps.getDataPlanVersionPath.outputs.dataPlanPath }}

      - name: Modify Smartype Config Web Options
        uses: MerthinTechnologies/edit-json-action@v1
        with:
          filename: 'smartype.config.json'
          key: webOptions.enabled
          value: true

      - name: View Smartype Config
        run: cat smartype.config.json

      - name: Download Smartype Jar
        uses: actions/download-artifact@v2
        with:
          name: smartype-jar

      - name: Run smartype generator
        run: |
          java -jar smartype.jar generate
      - name: Copy Template Package.json
        run: cp template/package.json smartype-dist/web

      - name: NPM Install
        run: npm install
        working-directory: smartype-dist/web

      - name: NPM Publish
        run: npm publish
        working-directory: smartype-dist/web
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
